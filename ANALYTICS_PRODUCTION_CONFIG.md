## Production Analytics System - Configuration Guide

### ‚úÖ –°—Ç–∞—Ç—É—Å: –ì–û–¢–û–í–û –î–û –ü–†–û–î–ê–ö–®–ï–ù–£

–°–∏—Å—Ç–µ–º–∞ –ø–æ–≤–Ω—ñ—Å—Ç—é —ñ–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω–∞ –∑ Supabase —Ç–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è production.

---

## 1Ô∏è‚É£ –°–µ—Ä–µ–¥–æ–≤–∏—â–Ω—ñ –∑–º—ñ–Ω–Ω—ñ (Environment Variables)

–í—Å—ñ –∑–º—ñ–Ω–Ω—ñ **—É–∂–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ** –≤ Vercel:

```
‚úÖ NEXT_PUBLIC_SUPABASE_URL - –ü—É–±–ª—ñ—á–Ω–∞ URL Supabase
‚úÖ NEXT_PUBLIC_SUPABASE_ANON_KEY - –ü—É–±–ª—ñ—á–Ω–∏–π –∫–ª—é—á
‚úÖ SUPABASE_SERVICE_ROLE_KEY - Service role –∫–ª—é—á
‚úÖ ANALYTICS_SALT - –°—ñ–ª—å –¥–ª—è –∞–Ω–æ–Ω—ñ–º—ñ–∑–∞—Ü—ñ—ó IP
```

**–Ø–∫ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏:**
- –í—ñ–¥–∫—Ä–∏–π—Ç–µ Vars (–ª—ñ–≤–∞ –ø–∞–Ω–µ–ª—å v0)
- –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ –≤—Å—ñ 4 –∑–º—ñ–Ω–Ω—ñ —î –ø—Ä–∏—Å—É—Ç–Ω—ñ–º–∏

---

## 2Ô∏è‚É£ –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö

### –¢–∞–±–ª–∏—Ü—è: `page_views`

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å |
|------|-----|------|
| `id` | BIGSERIAL | –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID |
| `page_path` | TEXT | –®–ª—è—Ö —Å—Ç–æ—Ä—ñ–Ω–∫–∏ (–ø—Ä–∏–∫–ª–∞–¥: `/about`) |
| `visitor_hash` | TEXT | SHA-256 —Ö–µ—à (GDPR-compliant) |
| `session_id` | TEXT | ID —Å–µ—Å—ñ—ó |
| `created_at` | TIMESTAMP | –ß–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è |

### –Ü–Ω–¥–µ–∫—Å–∏ –¥–ª—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ:
- `created_at DESC` - –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –¥–∞–Ω–∏—Ö
- `page_path` - –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞–Ω–Ω—è –ø–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∞–º
- `visitor_hash` - –¥–ª—è —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ–≤
- `session_id` - –¥–ª—è —Å–µ—Å—ñ–π

### –ë–µ–∑–ø–µ–∫–∞:
- ‚úÖ Row Level Security (RLS) –≤–≤—ñ–º–∫–Ω–µ–Ω–æ
- ‚úÖ –¢—ñ–ª—å–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –º–æ–∂—É—Ç—å —á–∏—Ç–∞—Ç–∏
- ‚úÖ IP –∞–¥—Ä–µ—Å–∏ –∞–Ω–æ–Ω—ñ–º—ñ–∑–æ–≤–∞–Ω—ñ (–Ω–µ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è)
- ‚úÖ GDPR-compliant

---

## 3Ô∏è‚É£ API Endpoints

### POST `/api/analytics/ping`
–í—ñ–¥—Å—Ç–µ–∂—É—î –ø–µ—Ä–µ–≥–ª—è–¥ —Å—Ç–æ—Ä—ñ–Ω–∫–∏

**–ó–∞–ø–∏—Ç:**
```json
{
  "page": "/about",
  "sessionId": "session-123"
}
```

**–í—ñ–¥–ø–æ–≤—ñ–¥—å:**
```json
{
  "success": true,
  "tracked": true
}
```

**–©–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è:**
1. IP –∞–¥—Ä–µ—Å–∞ –º–∞—Å–∫—É—î—Ç—å—Å—è (IPv4: `10.0.0.0` ‚Üí `10.0.0.0`)
2. –ì–µ–Ω–µ—Ä—É—î—Ç—å—Å—è SHA-256 —Ö–µ—à –∑ IP + User-Agent + –î–∞—Ç–∞ + SALT
3. –î–∞–Ω—ñ –≤—Å—Ç–∞–≤–ª—è—é—Ç—å—Å—è –≤ Supabase —Ç–∞–±–ª–∏—Ü—é

---

### GET `/api/admin/analytics/stats`
–ü–æ–≤–µ—Ä—Ç–∞—î –∞–Ω–∞–ª—ñ—Ç–∏–∫—É –¥–ª—è –¥–∞—à–±–æ–∞—Ä–¥—É

**–í—ñ–¥–ø–æ–≤—ñ–¥—å:**
```json
{
  "onlineNow": 5,
  "totalPageViewsToday": 142,
  "uniqueVisitorsToday": 48,
  "popularPages": [
    { "path": "/", "views": 67 },
    { "path": "/about", "views": 35 }
  ],
  "weekly": [
    { "date": "2024-01-22", "views": 89 },
    { "date": "2024-01-23", "views": 142 }
  ]
}
```

**–†–æ–∑—Ä–∞—Ö—É–Ω–∫–∏:**
- `onlineNow` - –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑ —Å–µ—Å—ñ—è–º–∏ –≤ –æ—Å—Ç–∞–Ω–Ω—ñ 2 —Ö–≤–∏–ª–∏–Ω–∏
- `uniqueVisitorsToday` - –£–Ω—ñ–∫–∞–ª—å–Ω—ñ —Ö–µ—à—ñ –∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ
- `totalPageViewsToday` - –í—Å—ñ –ø–µ—Ä–µ–≥–ª—è–¥–∏ –∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ
- `popularPages` - Top 5 —Å—Ç–æ—Ä—ñ–Ω–æ–∫
- `weekly` - 7-–¥–µ–Ω–Ω–∏–π —Ç—Ä–µ–Ω–¥

---

## 4Ô∏è‚É£ Frontend Tracker

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:
- –ì–µ–Ω–µ—Ä—É—î session ID
- –î–µ—Ç–µ–∫—Ç—É—î –∑–º—ñ–Ω–∏ –º–∞—Ä—à—Ä—É—Ç—É
- –ù–∞–¥—Å–∏–ª–∞—î ping –∫–æ–∂–Ω—ñ 60 —Å–µ–∫—É–Ω–¥
- –ö–æ—Ä–∏—Å—Ç—É—î `keepalive: true` –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ

**–ú—ñ—Å—Ü–µ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è:**
```
/components/analytics/analytics-tracker.tsx
```

–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ –≤ `/app/[locale]/layout.tsx`

---

## 5Ô∏è‚É£ Dashboard

**–ê–¥—Ä–µ—Å–∞:** `http://localhost:3000/[locale]/admin`

**–ü–æ–∫–∞–∑—É—î:**
- 4 KPI –∫–∞—Ä—Ç–∫–∏ (Online, Views, Visitors, Avg)
- 7-–¥–µ–Ω–Ω–∏–π —Ç—Ä–µ–Ω–¥ (Line chart)
- Top 5 —Å—Ç–æ—Ä—ñ–Ω–æ–∫ (Bar chart)
- Auto-refresh –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥

**–î–∏–∑–∞–π–Ω:**
- –ö–æ–ª—å–æ—Ä–æ–≤—ñ KPI –∫–∞—Ä—Ç–∫–∏ –∑ —ñ–∫–æ–Ω–∫–∞–º–∏
- Gradient fill –ø—ñ–¥ –≥—Ä–∞—Ñ—ñ–∫–æ–º
- –¢–µ–º–Ω–∞ —Ç–µ–º–∞ –¥–ª—è Tooltip
- Responsive layout

---

## 6Ô∏è‚É£ –ê–Ω–æ–Ω—ñ–º—ñ–∑–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö (GDPR Compliant)

### –Ø–∫ –ø—Ä–∞—Ü—é—î:

```
1. IP –∞–¥—Ä–µ—Å–∞: 192.168.1.123 ‚Üí –º–∞—Å–∫–∞ ‚Üí 192.168.1.0
2. User-Agent: Mozilla/5.0... ‚Üí –±–µ–∑ –∑–º—ñ–Ω
3. –î–∞—Ç–∞: 2024-01-23
4. SALT: $ANALYTICS_SALT (–≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑)

5. Data = "192.168.1.0::Mozilla/5.0...::2024-01-23::$SALT"
6. visitor_hash = SHA-256(Data)
7. –†–µ–∑—É–ª—å—Ç–∞—Ç: "a3c8f2d9e1b4..."
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- ‚úÖ IP –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –ë–î
- ‚úÖ –¢–æ–π –∂–µ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á = —Ç–æ–π –∂–µ —Ö–µ—à
- ‚úÖ –Ü–Ω—à–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á = —ñ–Ω—à–∏–π —Ö–µ—à
- ‚úÖ –ù–µ –º–æ–∂–Ω–∞ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ IP –∑ —Ö–µ—à–∞
- ‚úÖ GDPR-safe

---

## 7Ô∏è‚É£ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –ì–µ–Ω–µ—Ä—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö:

```bash
# 1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ —Å–∞–π—Ç
# 2. –ü–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ –∫—ñ–ª—å–∫–∞ —Å—Ç–æ—Ä—ñ–Ω–æ–∫
# 3. –ü–æ—á–µ–∫–∞–π—Ç–µ 60+ —Å–µ–∫—É–Ω–¥
# 4. –û—Ç–∫—Ä–æ–π—Ç–µ /admin
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤ Supabase:

```sql
SELECT COUNT(*) FROM page_views;
SELECT DISTINCT page_path FROM page_views;
SELECT visitor_hash, COUNT(*) FROM page_views GROUP BY visitor_hash;
```

---

## 8Ô∏è‚É£ Production Deployment

### –ù–∞ Vercel:

1. **–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ –∑–º—ñ–Ω–Ω—ñ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ:**
   ```
   Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables
   ```

2. **–î–∞–π—Ç–µ –¥–æ–∑–≤—ñ–ª –Ω–∞ —á–∏—Ç–∞–Ω–Ω—è –ë–î:**
   - Supabase Dashboard ‚Üí RLS Policies
   - –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ `authenticated` role –º–∞—î –¥–æ–∑–≤—ñ–ª –Ω–∞ read

3. **Deploy:**
   ```bash
   git push origin main
   ```

4. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ logs:**
   ```
   Vercel ‚Üí Deployments ‚Üí Logs
   ```

---

## 9Ô∏è‚É£ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "supabaseKey is required"
**–†—ñ—à–µ–Ω–Ω—è:** –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ `NEXT_PUBLIC_SUPABASE_URL` —Ç–∞ `NEXT_PUBLIC_SUPABASE_ANON_KEY` –≤ Vars

### –ü—Ä–æ–±–ª–µ–º–∞: Analytics –Ω–µ –∑'—è–≤–ª—è—î—Ç—å—Å—è
**–†—ñ—à–µ–Ω–Ω—è:** 
1. –ü–æ—á–µ–∫–∞–π—Ç–µ 60+ —Å–µ–∫—É–Ω–¥ (heartbeat interval)
2. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –±—Ä–∞—É–∑–µ—Ä–Ω—É –∫–æ–Ω—Å–æ–ª—å –Ω–∞ –ø–æ–º–∏–ª–∫–∏
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ `/api/admin/analytics/stats` –≤—Ä—É—á–Ω—É

### –ü—Ä–æ–±–ª–µ–º–∞: –î–∞–Ω—ñ –≤—Ç—Ä–∞—á–∞—é—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
**–¶–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ** - –¥–∞–Ω—ñ –≤ Supabase –ë–î, –∞ –Ω–µ –≤ –ø–∞–º'—è—Ç—ñ

---

## üîü Performance

| –û–ø–µ—Ä–∞—Ü—ñ—è | –ß–∞—Å |
|----------|-----|
| Ping endpoint | ~100ms |
| Fetch stats | ~200ms |
| Dashboard render | ~300ms |

**–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó:**
- –Ü–Ω–¥–µ–∫—Å–∏ –Ω–∞ –≤—Å—ñ—Ö search –ø–æ–ª—è—Ö
- Auto-refresh: 30 —Å–µ–∫ (–Ω–µ –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂—É—î)
- Materialized view –¥–ª—è –¥–Ω–µ–≤–Ω–æ—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

---

## –ì–æ—Ç–æ–≤–æ –¥–æ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É! ‚úÖ

–°–∏—Å—Ç–µ–º–∞ –ø–æ–≤–Ω—ñ—Å—Ç—é —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∞ —ñ –±–µ–∑–ø–µ—á–Ω–∞.
